# Compose spec: version key deprecated; relying on latest schema.
services:
  postgres:
    image: postgres:15-alpine
    container_name: nakama-postgres
    restart: unless-stopped
    environment:
      POSTGRES_PASSWORD: localdev
      POSTGRES_USER: nakama
      POSTGRES_DB: nakama0000
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U nakama -d nakama0000"]
      interval: 5s
      timeout: 3s
      retries: 20

  nakama:
    image: heroiclabs/nakama:3.21.0
    container_name: nakama
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    entrypoint:
      - "/bin/sh"
      - "-ecx"
      - >
        /nakama/nakama migrate up --database.address nakama:localdev@postgres:5432/nakama0000 &&
        exec /nakama/nakama --name nakama1 --database.address nakama:localdev@postgres:5432/nakama0000 --logger.level DEBUG --session.token_expiry_sec 7200 --config /nakama/data/local.yml --runtime.path /nakama/data/modules
    environment:
      - NAKAMA_DATABASE_ADDRESS=nakama:localdev@postgres:5432/nakama0000
    volumes:
      - ./modules:/nakama/data/modules
      - ./local.yml:/nakama/data/local.yml:ro
    ports:
      - "7460:7460"
      - "7461:7461"
      - "9100:9100"

  caddy:
    image: caddy
    container_name: caddy
    restart: unless-stopped
    depends_on:
      - nakama
    environment:
      - CADDY_DOMAIN=${CADDY_DOMAIN:-}
      - CADDY_EMAIL=${CADDY_EMAIL:-}
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
volumes:
  pgdata: {}
  caddy_data: {}
  caddy_config: {}
